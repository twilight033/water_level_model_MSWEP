# 为什么MSWEP的1000个流域还会被筛选掉？

## 问题

既然：
1. **MSWEP包含的1000个流域** = 候选列表的前1000个
2. 这1000个流域已经有MSWEP数据

那为什么运行时还会筛选掉176个？

## 答案：两种"验证"不是一回事！

### 候选列表的"验证" (scan_waterlevel_basins.py)

```python
# 只检查：文件是否存在
if os.path.exists(f"{basin_id}_waterlevel.nc"):
    VALID_WATER_LEVEL_BASINS.append(basin_id)
```

**标准**：
- ✓ 有水位数据文件存在
- ❌ 不检查数据是否有效
- ❌ 不检查是否全为NaN
- ❌ 不检查有效数据比例

**结果**：5767个候选流域

### 运行时的"验证" (filter_basins_with_valid_data)

```python
# 检查：数据是否真的可用
def filter_basins_with_valid_data(...):
    # 读取径流数据
    flow_data = read_streamflow(basin_id)
    # 读取水位数据
    waterlevel_data = read_waterlevel(basin_id)
    
    # 检查1：是否全为NaN？
    if flow_data.isna().all() or waterlevel_data.isna().all():
        return False  # 淘汰！
    
    # 检查2：有效数据比例 ≥ 10%？
    valid_ratio = (~flow_data.isna()).sum() / len(flow_data)
    if valid_ratio < 0.1:
        return False  # 淘汰！
    
    return True  # 通过！
```

**标准**：
- ✓ 有水位数据文件存在
- ✓ 径流数据不全为NaN
- ✓ 水位数据不全为NaN
- ✓ 有效数据比例 ≥ 10%

## 关键差异

| 项目 | 候选列表 | 运行时验证 |
|------|---------|-----------|
| 检查内容 | 文件存在性 | 数据有效性 |
| 检查深度 | 浅（只看文件名） | 深（读取并分析数据） |
| 时间成本 | 很快 | 较慢（~2秒/流域） |
| 结果 | 5767个候选 | ~500-1000个有效 |

## 实际流程演示

### 候选列表前10个流域

```
01011000  ← 候选列表: ✓ 文件存在
01013500  ← 候选列表: ✓ 文件存在  
01015800  ← 候选列表: ✓ 文件存在
01017000  ← 候选列表: ✓ 文件存在
01017060  ← 候选列表: ✓ 文件存在
01017290  ← 候选列表: ✓ 文件存在
01017550  ← 候选列表: ✓ 文件存在
01017960  ← 候选列表: ✓ 文件存在
01018000  ← 候选列表: ✓ 文件存在
01018009  ← 候选列表: ✓ 文件存在
```

**MSWEP包含**：这前10个（以及前1000个）

### 运行时验证这前10个

```python
验证 01011000:
  读取径流数据... 全是NaN ❌
  → 淘汰！

验证 01013500:
  读取径流数据... 有效数据5% < 10% ❌
  → 淘汰！

验证 01015800:
  读取水位数据... 全是NaN ❌
  → 淘汰！

验证 01017000:
  径流数据: 有效率85% ✓
  水位数据: 有效率92% ✓
  → 通过！第1个有效流域

验证 01017060:
  径流数据: 有效率78% ✓
  水位数据: 有效率88% ✓
  → 通过！第2个有效流域

... 继续验证 ...
```

### 验证前1000个候选（都在MSWEP中）

```
验证前1000个候选流域...
结果：
  通过验证: ~400个
  被淘汰: ~600个（文件存在但数据无效）
```

### 继续验证第1001-1500个（不在MSWEP中）

```
验证第1001-1500个候选流域...
结果：
  通过验证: ~200个
  被淘汰: ~300个
```

### 最终选择500个

```
从所有通过验证的流域（~600个）中选前500个：
  来自前1000个候选: ~324个 ← 在MSWEP中 ✓
  来自第1001-1500个: ~176个 ← 不在MSWEP中 ❌
```

## 为什么前1000个被淘汰这么多？

### 常见的数据问题

1. **全NaN数据**
   ```
   流域文件存在，但里面全是NaN
   原因：测站停用、设备故障、数据丢失
   ```

2. **有效数据太少**
   ```
   只有几个月的数据，其余全是NaN
   有效率 < 10%
   ```

3. **径流和水位不匹配**
   ```
   径流数据有效，但水位数据全NaN
   或反之
   ```

### 实际示例（假设）

```
候选列表前1000个流域的数据质量分布：

完全有效（有效率>90%）: 200个  ← 优先选择
基本有效（有效率50-90%）: 150个  ← 也会选择
部分有效（有效率10-50%）: 100个  ← 可能选择
数据太少（有效率<10%）: 250个  ← 淘汰 ❌
全是NaN: 300个  ← 淘汰 ❌

通过验证的: 450个
被淘汰的: 550个
```

**不够500个！** → 需要继续验证第1001-1500个

## 证据

从终端输出可以看到验证过程：

```bash
警告: 流域 01350180 的数据文件不存在
警告: 流域 01350355 的数据文件不存在
...
验证流域数据:  23%|██████████▋   | 7/30 [00:20<00:55,  2.42s/it]
```

这说明：
1. 有些候选流域连文件都不存在了（更新后删除？）
2. 验证过程很慢（~2.42秒/流域）
3. 不是所有候选流域都能通过验证

## 解决方案

### 问题根源

```
MSWEP (前1000个候选)
  → 但这1000个中~600个数据无效
  → 通过验证的只有~400个
  → 需要从第1001-1500个补充~100个
  → 这~100个不在MSWEP中
  → 最终只有324个可用
```

### 方案1：只使用MSWEP中通过验证的流域

```python
# 验证前1500个候选
validated_basins = filter_basins_with_valid_data(
    basin_list=VALID_WATER_LEVEL_BASINS[:1500],
    ...
)

# 筛选MSWEP中存在的
mswep_basins = load_mswep_basin_list()
validated_with_mswep = [b for b in validated_basins if b in mswep_basins]

# 从MSWEP覆盖的流域中选择
if len(validated_with_mswep) >= NUM_BASINS:
    chosen_basins = validated_with_mswep[:NUM_BASINS]
else:
    print(f"警告: MSWEP只覆盖 {len(validated_with_mswep)} 个有效流域")
    chosen_basins = validated_with_mswep  # 用全部
```

**结果**：可能只能用324个流域

### 方案2：验证更多候选流域

```python
# 验证前3000个候选（包括MSWEP的1000个）
max_candidates = 3000
validated_basins = filter_basins_with_valid_data(
    basin_list=VALID_WATER_LEVEL_BASINS[:3000],
    max_basins_to_check=3000,
    ...
)

# 优先选择MSWEP中的流域
mswep_basins = load_mswep_basin_list()
validated_with_mswep = [b for b in validated_basins if b in mswep_basins]
chosen_basins = validated_with_mswep[:NUM_BASINS]
```

**优点**：验证更多候选，从前1000个中找到更多有效流域

### 方案3：扩充MSWEP到前2000个候选

下载前2000个候选流域的MSWEP数据，确保覆盖足够多的有效流域。

## 总结

### 你的疑问

> 这1000个不是已经经过验证的流域吗？

**答案**：

❌ **不是！** 候选列表的"验证"只是文件存在性检查

✓ **运行时验证才是真正的数据有效性检查**

### 关键事实

1. **候选列表前1000个** = 有水位文件的流域（浅层检查）
2. **MSWEP包含的1000个** = 这前1000个候选流域
3. **运行时验证** = 深度检查数据有效性
4. **前1000个中~600个被淘汰** → 数据无效（NaN/有效率低）
5. **需要从第1001-1500个补充** → 这些不在MSWEP中
6. **最终只有324个可用**

### 根本原因

**"有水位文件" ≠ "数据有效"**

很多流域虽然有文件，但：
- 数据全是NaN
- 有效数据太少（<10%）
- 径流或水位缺失
- 需要同时有有效的径流和水位数据

---

**生成时间**: 2026-01-21
