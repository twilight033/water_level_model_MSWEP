"""
对比实际选择的流域和MSWEP文件包含的流域
"""

import pandas as pd

# 从终端输出复制的实际选择的500个流域
actual_basins_str = "['01017000', '01017060', '01017290', '01017960', '01018000', '01018009', '01019000', '01021200', '01027200', '01029200', '01029500', '01030500', '01031300', '01031450', '01031500', '01031510', '01037380', '01042500', '01043500', '01044550', '01046000', '01046500', '01047150', '01047200', '01048220', '01052500', '01054200', '01054300', '01055000', '01059000', '01060000', '01064801', '01067950', '01068910', '01069500', '01069700', '01072800', '01073000', '01073319', '01073500', '010735562', '01073587', '01073785', '01074520', '01075000', '01076000', '01076500', '01077400', '01078000', '01081000', '01081500', '01082000', '01085000', '01085500', '01086000', '01089100', '01089500', '01091000', '01091500', '01092000', '01093852', '01094000', '01096000', '01096500', '010965852', '01097000', '01097300', '01098530', '01099500', '01100000', '01100505', '01100561', '01100600', '01100627', '01101000', '01101500', '01103280', '01103455', '01108000', '01108410', '01109000', '01109060', '01109070', '01109403', '01109730', '01110000', '01111212', '01111300', '01111500', '01115630', '01115770', '01117370', '01117468', '01117800', '01118300', '01119500', '01121000', '01122000', '01122500', '01123000', '01125100', '01125500', '01127000', '01127500', '01129200', '01130000', '01133000', '01134500', '01135150', '01135500', '01139000', '01139800', '01142500', '01144000', '01150900', '01151500', '01152500', '01153000', '01153550', '01154000', '01154500', '01155500', '01157000', '01158000', '01160350', '01161000', '01162000', '01162500', '01163200', '01166500', '01168500', '01169000', '01169900', '01170000', '01170100', '01170500', '01171500', '01172500', '01173000', '01173500', '01174565', '01181000', '01183500', '01184000', '01184100', '01185500', '01186000', '01186500', '01187300', '01188000', '01188090', '01189000', '01189995', '01191000', '01192500', '01192883', '01193500', '01194000', '01195490', '01196500', '01196561', '01196620', '01197000', '01198000', '01198125', '01203805', '01208950', '01208990', '01331500', '01333000', '01382170', '01382500', '01396091', '01396190', '01432110', '01439800', '01449800', '01451000', '01451800', '01455500', '01460880', '01461300', '01468500', '01469500', '01470500', '01470779', '01470960', '01471000', '01471510', '01472000', '01473500', '01492500', '01493500', '01518700', '01518862', '01520000', '01534500', '01534860', '01548005', '01553700', '01555000', '01555500', '01564500', '01566000', '01567500', '01599000', '01601000', '01601500', '01603000', '01604500', '01605500', '01606000', '01606500', '01607500', '01608000', '01608500', '01609000', '01610000', '01610155', '01611500', '01613000', '01613050', '01613095', '01613525', '01613900', '01614000', '01614500', '01615000', '01616100', '01616500', '01617000', '01617800', '01618000', '01619000', '01619500', '01620500', '01621050', '01622000', '01625000', '01626000', '01626850', '01627500', '01628500', '01629500', '01631000', '01632000', '01632082', '01632900', '01633000', '01634000', '01634500', '01635500', '01636316', '01636500', '01636690', '01637500', '01638480', '01638500', '01639500', '01643395', '01646500', '01658500', '01661050', '01662800', '01663500', '01664000', '01665500', '01666500', '01667500', '01669000', '01669520', '02011400', '02011460', '02011470', '02011490', '02011500', '02011800', '02013000', '02013100', '02014000', '02015700', '02016000', '02016500', '02017500', '02018000', '02018500', '02019500', '02020500', '02021500', '02022500', '02024000', '02024752', '02024915', '02025500', '02026000', '02027000', '02027500', '02028500', '02029000', '02030500', '02032250', '02032640', '02035000', '02037500', '02038850', '0204382800', '02046000', '02051000', '02051500', '02054500', '02054530', '02055000', '02056000', '02056650', '02068500', '02069700', '02070000', '02070500', '02071530', '02074500', '02118500', '02152474', '02157470', '02157490', '02167450', '02197300', '02228500', '02231000', '02231342', '02235200', '02236500', '02245500', '02246000', '02266200', '02268390', '02295013', '02296500', '02322700', '02322800', '02342850', '02343225', '02343940', '02365470', '02365769', '02366996', '02371500', '02372250', '02373000', '02374500', '02374745', '02374950', '02388900', '02388975', '02390000', '02391540', '02391840', '02392360', '02399200', '02400100', '02400680', '02401000', '02401390', '02404400', '02405500', '02407000', '02407514', '02408540', '02415000', '02420000', '02422500', '02423130', '02423380', '02423397', '02423400', '02423414', '02423425', '02423496', '02423500', '0242354750', '02423555', '02423630', '02424000', '02427250', '02438000', '02448900', '02449882', '02450000', '02450180', '02450250', '02450825', '02453000', '02454055', '02455000', '02455185', '02455980', '02456000', '02456500', '02457000', '02457595', '02458300', '02458450', '02458600', '02461500', '02462000', '02464000', '02464146', '02465000', '02465493', '02466030', '02467500', '02469800', '02470072', '02479945', '03010655', '03011800', '03015500', '03017500', '03021350', '03022540', '03026500', '03028000', '03031500', '03032500', '03034000', '03034500', '03036000', '03036500', '03038000', '03039000', '03040000', '03041029', '03041500', '03042000', '03042280', '03042500', '03044000', '03045000', '03047000', '03048500', '03049000', '03049500', '03049800', '03050000', '03050500', '03051000', '03052000', '03052500', '03053500', '03054500', '03056000', '03056250', '03057000', '03058000', '03058500', '03061000', '03065400', '03066000', '03067510', '03068800', '03069500', '03070500', '03072000', '03075905', '03076600', '03078000', '03085500', '03092460', '03093000', '03094000', '03095500', '03098600', '03099500', '03101500', '03102500', '03102850', '03103500', '03105500', '03106000', '03106300', '03106500', '03107500', '03108000', '03109500', '03110000', '03111500', '03114500', '03115400', '03116000', '03116077', '03118000', '03118500', '03124500', '03126000', '03127000', '03128500', '03139000', '03140000', '03140500', '03141500', '03141870']"

import ast
actual_basins = ast.literal_eval(actual_basins_str)

print("="*80)
print("对比实际选择的流域 vs MSWEP文件包含的流域")
print("="*80)

# 读取MSWEP文件的列名
print("\n[1] 读取MSWEP文件...")
mswep_file = "MSWEP/mswep_1000basins_mean_3hourly_1980_2024.csv"
df_header = pd.read_csv(mswep_file, nrows=0)
mswep_basins = df_header.columns.tolist()[1:]  # 去掉第一列（时间）

print(f"  实际选择的流域数量: {len(actual_basins)}")
print(f"  MSWEP包含的流域数量: {len(mswep_basins)}")

# 对比
print("\n[2] 对比分析...")
matched = [b for b in actual_basins if b in mswep_basins]
missing = [b for b in actual_basins if b not in mswep_basins]

print(f"  匹配数量: {len(matched)}")
print(f"  缺失数量: {len(missing)}")
print(f"  匹配率: {len(matched)/len(actual_basins)*100:.1f}%")

# 显示缺失的流域
if missing:
    print(f"\n[3] MSWEP中缺失的流域 (共{len(missing)}个):")
    for i in range(0, len(missing), 10):
        batch = missing[i:i+10]
        print(f"  {', '.join(batch)}")
    
    # 保存缺失列表
    with open("actual_missing_in_mswep.txt", 'w') as f:
        f.write(f"# 实际选择但在MSWEP中缺失的流域\n")
        f.write(f"# 共 {len(missing)} 个\n\n")
        for basin in missing:
            f.write(f"{basin}\n")
    print(f"\n  已保存到: actual_missing_in_mswep.txt")

# 解释
print("\n" + "="*80)
print("原因分析")
print("="*80)
print("""
问题所在:
  1. 代码选择了500个验证通过的流域 (chosen_basins)
  2. 这500个流域不是候选列表的前500个，而是经过数据验证后的500个
  3. 其中有 {missing_count} 个流域在MSWEP数据文件中不存在
  4. load_mswep_data 筛选后只返回 {matched_count} 个流域的数据

解决方案:
  方案1: 更新MSWEP数据文件，包含这 {missing_count} 个缺失的流域
  方案2: 只使用MSWEP中存在的 {matched_count} 个流域进行训练
  方案3: 调整流域选择逻辑，优先选择MSWEP中存在的流域

推荐: 方案2 或方案3
  - 在 config.py 中设置 NUM_BASINS = {matched_count}
  - 或在流域验证时增加"MSWEP数据存在性"检查
""".format(
    missing_count=len(missing),
    matched_count=len(matched)
))
