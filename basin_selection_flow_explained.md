# 流域选择流程详解

## 你的疑问：验证通过和候选列表不是一个吗？

**答案**：不完全是！让我详细解释：

## 流域筛选的完整流程

```
┌─────────────────────────────────────────────────────────────────┐
│  第1步：候选列表 (valid_waterlevel_basins.txt)                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━              │
│  来源：scan_waterlevel_basins.py 扫描CAMELSH数据集              │
│  标准：有水位数据文件存在                                        │
│  数量：5767个流域                                                │
│                                                                  │
│  这只是检查"文件存在"，不检查数据质量！                         │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第2步：数据验证 (filter_basins_with_valid_data)                │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━              │
│  来源：从候选列表中逐个验证                                      │
│  标准：                                                          │
│    ✓ 径流数据有效（不全是NaN）                                  │
│    ✓ 水位数据有效（不全是NaN）                                  │
│    ✓ 有效数据比例 ≥ 10%                                         │
│                                                                  │
│  数量：max_candidates = NUM_BASINS * 3 = 500 * 3 = 1500个       │
│        (代码只验证前1500个候选流域，不是全部5767个)              │
│                                                                  │
│  验证通过：假设有1000个通过验证                                  │
│                                                                  │
│  ⚠️ 注意：这里没有检查MSWEP数据是否存在！                        │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第3步：选择流域 (chosen_basins)                                │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━              │
│  chosen_basins = validated_basins[:NUM_BASINS]                  │
│                                                                  │
│  从验证通过的流域中选择前500个                                   │
│  数量：500个流域                                                 │
└─────────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────────┐
│  第4步：MSWEP数据匹配 (load_mswep_data)                         │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━              │
│  MSWEP文件包含：1000个流域                                       │
│                                                                  │
│  与chosen_basins (500个) 对比：                                 │
│    ✓ 匹配：324个流域在MSWEP中存在                               │
│    ✗ 缺失：176个流域在MSWEP中不存在                             │
│                                                                  │
│  最终返回：324个流域的降雨数据                                   │
│                                                                  │
│  🔴 这就是为什么只有324个流域！                                  │
└─────────────────────────────────────────────────────────────────┘
```

## 关键点解释

### 1. 候选列表 ≠ 验证通过

| 特征 | 候选列表 | 验证通过 |
|------|---------|---------|
| 数量 | 5767个 | ~1000个（估计） |
| 检查内容 | 文件存在性 | 数据有效性 |
| 检查深度 | 浅（只看文件） | 深（读取并验证数据） |
| 是否检查MSWEP | ❌ 否 | ❌ 否 |

**关系**：验证通过的流域 ⊂ 候选列表

### 2. 验证过程的代码

```python
# 第1步：读取候选列表
VALID_WATER_LEVEL_BASINS = load_waterlevel_basins_from_file()
# 结果：5767个流域

# 第2步：验证前1500个候选流域
max_candidates = NUM_BASINS * 3  # 500 * 3 = 1500
validated_basins = filter_basins_with_valid_data(
    basin_list=VALID_WATER_LEVEL_BASINS,  # 从5767个中取
    max_basins_to_check=1500,              # 只验证前1500个
    min_valid_ratio=0.1                    # 有效数据≥10%
)
# 结果：假设800个验证通过

# 第3步：选择前500个
chosen_basins = validated_basins[:500]
# 结果：500个流域
```

### 3. 为什么验证过程不检查MSWEP？

**设计逻辑**：
- `filter_basins_with_valid_data` 只负责验证CAMELSH数据（径流+水位）
- MSWEP数据是后续加载的，验证时还没读取MSWEP文件
- 假设所有流域都应该有MSWEP数据（但实际不是！）

**问题所在**：
- MSWEP文件只包含1000个特定流域（不是全部CAMELSH流域）
- 验证通过的500个流域中，有176个不在这1000个中
- 导致最终只能使用324个流域

## 具体示例

### 候选列表前10个：
```
01011000, 01013500, 01015800, 01017000, 01017060, 
01017290, 01017550, 01017960, 01018000, 01018009
```

### 验证通过的前10个：
```
01017000, 01017060, 01017290, 01017960, 01018000,
01018009, 01019000, 01021200, 01027200, 01029200
```

**注意**：
- 候选列表中的 `01011000`, `01013500`, `01015800` **没有通过验证**
  - 可能原因：径流或水位数据全是NaN，或有效数据<10%
- 所以验证通过的列表从 `01017000` 开始，不是从 `01011000` 开始

### MSWEP文件包含的流域：
```
MSWEP有: 01017000, 01017060, 01018000, ...（共1000个）
MSWEP没有: 02167450, 02197300, 03141870, ...（很多02、03开头的）
```

### 最终结果：
```
验证通过: 500个流域
其中在MSWEP: 324个 ✓
其中不在MSWEP: 176个 ✗
```

## 为什么MSWEP只有1000个流域？

**可能原因**：
1. MSWEP数据提取时只选择了常用的1000个流域
2. MSWEP数据文件是单独生成的，不是全流域覆盖
3. 某些区域（如02xxx, 03xxx）的流域较少或被跳过

## 解决方案对比

### 当前问题
```
候选列表 (5767) 
  → 验证 → 通过验证 (~1000)
  → 选择 → chosen_basins (500)
  → MSWEP匹配 → 只有324个 ✗
```

### 解决方案1：修改NUM_BASINS
```
候选列表 (5767) 
  → 验证 → 通过验证 (~1000)
  → 选择 → chosen_basins (324)  ← 改这里
  → MSWEP匹配 → 324个 ✓
```

### 解决方案2：增加MSWEP预筛选
```
候选列表 (5767) 
  → 验证 → 通过验证 (~1000)
  → MSWEP预筛选 → 有MSWEP的流域 (~600)  ← 加这步
  → 选择 → chosen_basins (500)
  → MSWEP匹配 → 500个 ✓
```

代码示例：
```python
# 在选择流域前增加MSWEP筛选
print("\n正在筛选MSWEP数据中存在的流域...")
mswep_df = pd.read_csv("MSWEP/mswep_1000basins_mean_3hourly_1980_2024.csv", nrows=0)
mswep_basins = mswep_df.columns.tolist()[1:]

validated_basins_with_mswep = [
    b for b in validated_basins if b in mswep_basins
]
print(f"  验证通过: {len(validated_basins)}")
print(f"  MSWEP覆盖: {len(validated_basins_with_mswep)}")

chosen_basins = validated_basins_with_mswep[:NUM_BASINS]
print(f"  最终选择: {len(chosen_basins)}")
```

## 总结

**你的问题**：验证通过和候选列表不是一个吗？

**答案**：
1. **验证通过 ⊂ 候选列表**（验证通过是候选列表的子集）
2. **候选列表 (5767个)** → **验证通过 (~1000个)** → **选择500个**
3. **验证只检查CAMELSH数据，不检查MSWEP数据**
4. **500个中有176个不在MSWEP中** → **只能用324个**

**根本原因**：
- 验证流程没有考虑MSWEP数据的存在性
- MSWEP文件只包含1000个特定流域（不是全覆盖）

---

**生成时间**: 2026-01-21  
**相关文件**: multi_task_lstm_ablation_missing_labels.py (第1087-1115行)
