# Multi-Task LSTM 运行时配置提取结果

**生成时间**: 2025-12-27 16:53:26

## 概述

本文档记录了 `multi_task_lstm.py` 实际运行时使用的流域ID和时间段配置。

## 流域配置

### 基本信息
- **配置要求**: 100 个流域
- **实际使用**: 100 个流域
- **数据有效性验证**: 已通过（同时有有效的径流和水位数据，有效比例≥10%）

### 流域列表

实际使用的100个流域ID如下：

```
01017000, 01017060, 01017290, 01017960, 01018000,
01018009, 01019000, 01021200, 01027200, 01029200,
01029500, 01030500, 01031300, 01031450, 01031500,
01031510, 01037380, 01042500, 01043500, 01044550,
01046000, 01046500, 01047150, 01047200, 01048220,
01052500, 01054200, 01054300, 01055000, 01059000,
01060000, 01064801, 01067950, 01068910, 01069500,
01069700, 01072800, 01073000, 01073319, 01073500,
010735562, 01073587, 01073785, 01074520, 01075000,
01076000, 01076500, 01077400, 01078000, 01081000,
01081500, 01082000, 01085000, 01085500, 01086000,
01089100, 01089500, 01091000, 01091500, 01092000,
01093852, 01094000, 01096000, 01096500, 010965852,
01097000, 01097300, 01098530, 01099500, 01100000,
01100505, 01100561, 01100600, 01100627, 01101000,
01101500, 01103280, 01103455, 01108000, 01108410,
01109000, 01109060, 01109070, 01109403, 01109730,
01110000, 01111212, 01111300, 01111500, 01115630,
01115770, 01117370, 01117468, 01117800, 01118300,
01119500, 01121000, 01122000, 01122500, 01123000
```

### 流域选择过程

1. **候选流域**: 5,767 个（从 `valid_waterlevel_basins.txt` 读取）
2. **验证过程**: 检查前 300 个候选流域
3. **验证标准**:
   - 同时有径流和水位数据
   - 数据不全为NaN
   - 有效数据比例 ≥ 10%
4. **验证结果**: 168 个有效流域
5. **最终选择**: 前 100 个有效流域

## 时间配置

### 完整时间范围
- **开始日期**: 1980-01-01
- **结束日期**: 2024-12-31
- **总时长**: 16,436 天（约45年）
- **数据来源**: CAMELSH数据集默认时间范围

### 数据集划分

代码使用**按比例划分**方式，而非固定日期：

| 数据集 | 比例 | 开始日期 | 结束日期 | 时长（天） |
|--------|------|----------|----------|------------|
| **训练集** (Train) | 60% | 1980-01-01 | 2006-12-31 | 9,861 |
| **验证集** (Valid) | 20% | 2006-12-31 | 2015-12-31 | 3,287 |
| **测试集** (Test) | 20% | 2015-12-31 | 2024-12-31 | 3,287 |

### 划分说明

- **划分方式**: 按每个流域的完整时间序列比例划分（而非全局固定日期）
- **优点**: 每个流域都有自己的训练/验证/测试划分，适应不同流域的数据可用性
- **注意**: 上表中的日期是基于完整时间范围的理论划分，实际每个流域的划分可能略有不同

## 模型配置

### 输入序列
- **序列长度**: 100 步
- **时间分辨率**: 3 小时
- **输入窗口时长**: 300 小时 = 12.5 天

### 数据特点
- **强迫数据**: 3小时分辨率（来自MSWEP降雨 + CAMELSH其他气象变量）
- **目标数据**: 小时分辨率（径流和水位）
- **对齐方式**: 序列结束时刻的目标值作为预测目标

## 生成的文件

### 1. 流域列表文件

#### `runtime_basins.txt`
- **格式**: Python列表
- **用途**: 可直接复制到Python代码中使用
- **示例**:
  ```python
  CHOSEN_BASINS = [
      '01017000',
      '01017060',
      ...
  ]
  ```

#### `runtime_basins.csv`
- **格式**: CSV（列：basin_id, index）
- **用途**: 可导入Excel、数据库等
- **总行数**: 100行

### 2. 时间配置文件

#### `runtime_time_config.txt`
- **格式**: 纯文本
- **内容**: 包含完整时间范围和各数据集划分详情
- **用途**: 人类可读的配置文档

#### `runtime_time_config.csv`
- **格式**: CSV（列：dataset, start_date, end_date, duration_days, ratio）
- **用途**: 可导入Excel、数据库等
- **总行数**: 3行（Train, Valid, Test）

## 使用方法

### 1. 在Python中使用流域列表

```python
# 方法1: 直接导入文本文件
with open('runtime_basins.txt', 'r') as f:
    exec(f.read())
    # 现在可以使用 CHOSEN_BASINS 变量

# 方法2: 读取CSV
import pandas as pd
basins_df = pd.read_csv('runtime_basins.csv')
basin_ids = basins_df['basin_id'].tolist()
```

### 2. 查看时间配置

```python
import pandas as pd

# 读取时间配置
time_config = pd.read_csv('runtime_time_config.csv')
print(time_config)

# 获取训练集时间范围
train_start = time_config.loc[time_config['dataset'] == 'Train', 'start_date'].values[0]
train_end = time_config.loc[time_config['dataset'] == 'Train', 'end_date'].values[0]
```

### 3. 在USGS Qualifiers Fetcher中使用

如果要为这100个流域获取USGS qualifiers数据：

```python
# 读取流域列表
import pandas as pd
basins_df = pd.read_csv('runtime_basins.csv')
GAUGE_IDS = basins_df['basin_id'].tolist()

# 读取时间配置
time_config = pd.read_csv('runtime_time_config.csv')

# 获取训练集时间范围（通常用于获取qualifiers）
train_row = time_config[time_config['dataset'] == 'Train'].iloc[0]
START_YEAR = int(train_row['start_date'][:4])  # 1980
END_YEAR = int(train_row['end_date'][:4])      # 2006

# 运行qualifiers fetcher
# python qualifiers_fetcher/fetch_full_range.py
```

## 注意事项

### 1. 时间划分的特点
- 代码使用的是**动态时间划分**，而非config.py中的固定日期
- 每个流域根据其数据可用性独立划分
- 这样做的好处是更灵活，但可能导致不同流域的训练/测试时期略有差异

### 2. 数据分辨率
- **强迫数据（输入）**: 3小时分辨率
- **目标数据（输出）**: 小时分辨率
- 代码会自动处理两种分辨率的对齐

### 3. 数据有效性
- 所有100个流域都经过验证
- 确保同时有有效的径流和水位数据
- 有效数据比例 ≥ 10%
- 训练时会自动跳过NaN值

## 更新配置

如果需要重新提取配置（例如修改了NUM_BASINS或其他参数）：

```bash
uv run python extract_runtime_config.py
```

这会重新生成所有配置文件。

## 相关文件

- `extract_runtime_config.py`: 配置提取脚本
- `multi_task_lstm.py`: 主训练脚本
- `config.py`: 全局配置文件
- `valid_waterlevel_basins.txt`: 候选流域列表

---

**文档版本**: 1.0  
**最后更新**: 2025-12-27

